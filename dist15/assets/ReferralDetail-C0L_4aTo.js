import{r as a,i as q,e as Q,j as e,S as V,o as X,p as Y,q as Z}from"./index-0Q9RoQHO.js";import{B as ee}from"./Button-ns0xbH6B.js";import{y as x,L as te}from"./ReactToastify-BaEpz83A.js";const N="/api",R=r=>{const g=(r||"").trim().charAt(0);return g?g.toUpperCase():"?"},le=()=>{const[r,g]=a.useState(null),[B,C]=a.useState(!1),[y,I]=a.useState([]),{membersFromApi:_,loading:O}=q(),[i,z]=a.useState(null),[U,D]=a.useState(!1),[o,L]=a.useState(""),[T,P]=a.useState(""),[w,v]=a.useState(!1),{user:A}=Q(),[$]=a.useState(()=>(localStorage.getItem("userBizType")||"").trim().toLowerCase()),M=a.useMemo(()=>(A?.biz_type||"").trim().toLowerCase()||$,[A?.biz_type,$]),c=/^(sole|sole\s*trader|solo|sole_trader)$/i.test(M),u=a.useRef(null),S=a.useRef(null),E=a.useRef(null),[f,p]=a.useState(!1),[h,d]=a.useState(-1),m=a.useMemo(()=>c?["completed","cancelled"]:["Accept","Reject"],[c]);a.useEffect(()=>{if(!f)return;const t=s=>{const n=s.target;S.current&&!S.current.contains(n)&&u.current&&!u.current.contains(n)&&(p(!1),d(-1))};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[f]);const F=t=>{(t.key==="ArrowDown"||t.key==="Enter"||t.key===" ")&&(t.preventDefault(),p(!0),setTimeout(()=>{E.current?.focus(),d(0)},0))},G=t=>{if(m.length)if(t.key==="ArrowDown")t.preventDefault(),d(s=>(s+1)%m.length);else if(t.key==="ArrowUp")t.preventDefault(),d(s=>(s-1+m.length)%m.length);else if(t.key==="Enter"){t.preventDefault();const s=m[Math.max(0,h)];s&&(L(s),p(!1),d(-1),u.current?.focus())}else t.key==="Escape"&&(t.preventDefault(),p(!1),d(-1),u.current?.focus())},b=a.useCallback(async()=>{const t=localStorage.getItem("accessToken"),s=localStorage.getItem("selectedReferralId");try{C(!0);const l=await(await fetch(`${N}/refer/list_company_referral/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:s})})).json(),j=Array.isArray(l.referrals)?l.referrals[0]:null;g(j)}catch{x.error("⚠️ Failed to load referral detail")}finally{C(!1)}},[]);a.useEffect(()=>{b()},[b]),a.useEffect(()=>{(async()=>{try{const s=localStorage.getItem("accessToken"),n=localStorage.getItem("selectedId"),l=await fetch(`${N}/activity/?referral_id=${encodeURIComponent(n||"")}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:s?`Bearer ${s}`:""}}),j=await l.json();l.ok&&Array.isArray(j.results)&&I(j.results)}catch(s){console.error("Network error (activity):",s)}})()},[]);const H=async()=>{if(r){if(!o){x.error("⚠️ Please select a status.");return}v(!0);try{const t=localStorage.getItem("accessToken");if(c){const s=await fetch(`${N}/refer/complete1_referral/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:r.id,status:o})});if(!s.ok){const l=await s.text();x.error(`${l}`);return}const n=await s.json();x.success("✅ Status updated successfully!"),console.log("Sole status update response:",n),await b()}else{if(o!=="Reject"&&!i){x.error("⚠️ Please select an employee before proceeding."),v(!1);return}const s=await fetch(`${N}/refer/assign_rep/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:r.id,status:o,employee_id:o==="Reject"?null:i?.id,note:T||""})});if(!s.ok){const l=await s.text();x.error(`Failed: ${s.status} - ${l}`);return}const n=await s.json();x.success("✅ Status updated successfully!"),console.log("Assign/Status update response:",n),await b()}}catch{x.error("Network error, please try again")}finally{v(!1)}}};if(B||!r)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(V,{})});const k=["completed","cancelled"].includes((r.status||"").toLowerCase()),K=!c&&!k?!0:!!(c&&!k),J=c?w||!o:w||!o||o!=="Reject"&&!i,W=t=>{const s=(t||"").toLowerCase();return s==="completed"?"text-emerald-600 bg-emerald-50":s==="cancelled"?"text-blue-600 bg-blue-50":"text-amber-600 bg-amber-50"};return e.jsxs("div",{className:"p-4 sm:p-6 flex flex-col min-h-screen space-y-6",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-semibold text-primary-blue text-center sm:text-left",children:"Referral Details"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsxs("div",{className:"flex flex-col items-start gap-1 sm:gap-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Reference ID"}),e.jsxs("p",{className:"font-semibold text-primary-blue text-sm sm:text-base",children:["#",r.reference_id]})]}),e.jsxs("div",{className:"text-left sm:text-right mt-3 sm:mt-0 flex flex-col items-start sm:items-end",children:[e.jsx("p",{className:"text-xs text-gray-500",children:r.date}),e.jsx("span",{className:`inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium mt-2 ${W(r.status)}`,children:r.status})]})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Customer Info"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 sm:gap-4",children:[e.jsx("img",{src:`https://ui-avatars.com/api/?name=${encodeURIComponent(r.referred_to_name||"User")}&background=E5E7EB&color=374151`,alt:r.referred_to_name,className:"h-10 w-10 sm:h-12 sm:w-12 rounded-full object-cover"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"font-medium text-primary-blue text-sm sm:text-base",children:r.referred_to_name}),e.jsxs("p",{className:"text-xs text-gray-600 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 pb-2",children:[e.jsxs("span",{className:`flex items-center gap-1 ${r.privacy?"blur-sm select-none":""}`,children:[e.jsx(X,{className:"text-gray-500 text-sm"}),r.referred_to_email]}),e.jsxs("span",{className:`flex items-center gap-1 ${r.privacy?"blur-sm select-none":""}`,children:[e.jsx(Y,{className:"text-gray-500"}),r.referred_to_phone]})]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Reason:"})," ",r.reason]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Notes:"})," ",r.notes]})]})]}),e.jsx("div",{children:e.jsx("span",{className:`inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium capitalize
                ${(r.urgency||"").toLowerCase()==="urgent"?"text-rose-500 bg-rose-50":(r.urgency||"").toLowerCase()==="normal"?"text-blue-500 bg-blue-50":"text-slate-500 bg-slate-50"}`,children:r.urgency})})]})]}),k?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Activity Log"}),e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-[7px] top-0 bottom-0 w-px bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:y.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No activity yet."}):y.map(t=>{const s=new Date(t.created_at),n=s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),l=s.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-[22px] top-1 h-3 w-3 rounded-full bg-emerald-500"}),e.jsx("p",{className:"text-xs text-gray-500",children:n}),e.jsx("p",{className:"text-primary-blue font-medium text-sm",children:t.title}),e.jsx("p",{className:"text-xs text-gray-500",children:t.body}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:l})]},t.id)})})]})]})}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6",children:[!c&&!r.assigned_to_id&&e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Assignment"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>D(t=>!t),className:"w-full border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base text-left focus:outline-none focus:ring-2 focus:ring-primary-purple flex justify-between items-center",children:[i?i.name:"Select Employee",e.jsx(Z,{className:"text-gray-400"})]}),U&&e.jsx("div",{className:"absolute z-20 mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto",children:O?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"Loading..."}):_.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No team members found"}):_.map(t=>e.jsxs("div",{onClick:()=>{z(t),D(!1)},className:"flex items-center gap-3 px-4 py-2 cursor-pointer hover:bg-gray-50",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-black flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm font-semibold",children:R(t.name)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:t.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.email})]})]},t.id))})]}),i&&e.jsxs("div",{className:"mt-5 flex items-center gap-3 p-3 border border-gray-100 rounded-xl bg-gray-50",children:[e.jsx("div",{className:"h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-black flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm sm:text-base font-semibold",children:R(i.name)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:i.name}),e.jsx("p",{className:"text-xs text-gray-500",children:i.email})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"⚠️ Only one employee can be assigned."})]}),K&&e.jsxs("div",{className:`bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6 ${c&&!r.assigned_to_id?"lg:col-span-2":""}`,children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Status Update"}),e.jsxs("div",{className:"relative",ref:S,children:[e.jsxs("button",{ref:u,type:"button",onClick:()=>{p(t=>!t),setTimeout(()=>d(0),0)},onKeyDown:F,"aria-haspopup":"listbox","aria-expanded":f,className:`group w-full px-4 pr-10 py-3 rounded-xl bg-white border border-gray-200 text-left\r
                             text-sm text-gray-800 outline-none focus:ring-2 focus:ring-primary-purple relative`,children:[o||"Select status",e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 transition-transform",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-4 w-4 transition-transform ${f?"rotate-180":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),f&&e.jsx("div",{className:"absolute z-30 mt-2 w-full bg-white border border-gray-200 rounded-2xl shadow-xl overflow-hidden",children:e.jsx("ul",{ref:E,tabIndex:0,onKeyDown:G,role:"listbox","aria-activedescendant":h>=0&&m[h]?`status-${m[h]}`:void 0,className:"max-h-60 overflow-y-auto py-1 focus:outline-none",children:m.map((t,s)=>{const n=s===h,l=o===t;return e.jsx("li",{role:"option","aria-selected":l,children:e.jsxs("button",{id:`status-${t}`,type:"button",onMouseEnter:()=>d(s),onClick:()=>{L(t),p(!1),d(-1),u.current?.focus()},className:["w-full px-4 py-2.5 flex items-center gap-3 text-left transition",n?"bg-primary-purple/10":"hover:bg-primary-purple/10"].join(" "),children:[e.jsx("span",{className:"text-sm text-primary-blue",children:t}),l&&e.jsx("span",{className:"ml-auto text-primary-purple text-sm",children:"✓"})]})},t)})})})]}),!c&&e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"text-sm font-semibold text-primary-blue mt-5",children:"Note"}),e.jsx("textarea",{placeholder:"Write here...",value:T,onChange:t=>P(t.target.value),className:"w-full mt-2 border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-purple",rows:4})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(ee,{text:w?"Submitting...":"Done",onClick:H,disabled:J})})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Activity Log"}),e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-[7px] top-0 bottom-0 w-px bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:y.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No activity yet."}):y.map(t=>{const s=new Date(t.created_at),n=s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),l=s.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-[22px] top-1 h-3 w-3 rounded-full bg-emerald-500"}),e.jsx("p",{className:"text-xs text-gray-500",children:n}),e.jsx("p",{className:"text-primary-blue font-medium text-sm",children:t.title}),e.jsx("p",{className:"text-xs text-gray-500",children:t.body}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:l})]},t.id)})})]})]})]}),e.jsx(te,{position:"top-right",autoClose:3e3,hideProgressBar:!0})]})};export{le as default};
