import{r,i as Z,e as ee,j as e,S as te,o as se,p as ae,q as re}from"./index-BWkKWa2F.js";import{B as le}from"./Button-DKZIAQRV.js";import{y as u,L as ne}from"./ReactToastify-FoD0jKfJ.js";const v="/api",D=a=>{const y=(a||"").trim().charAt(0);return y?y.toUpperCase():"?"},me=()=>{const[a,y]=r.useState(null),[R,A]=r.useState(!1),[j,U]=r.useState([]),{membersFromApi:L,loading:P}=Z(),[d,F]=r.useState(null),[M,$]=r.useState(!1),[c,T]=r.useState(""),[E,G]=r.useState(""),[S,_]=r.useState(!1),{user:I}=ee(),[B]=r.useState(()=>(localStorage.getItem("userBizType")||"").trim().toLowerCase()),H=r.useMemo(()=>(I?.biz_type||"").trim().toLowerCase()||B,[I?.biz_type,B]),o=/^(sole|sole\s*trader|solo)$/i.test(H),p=r.useRef(null),k=r.useRef(null),O=r.useRef(null),[g,f]=r.useState(!1),[b,m]=r.useState(-1),x=r.useMemo(()=>o?["completed","cancelled"]:["accept","reject"],[o]);r.useEffect(()=>{if(!g)return;const t=s=>{const l=s.target;k.current&&!k.current.contains(l)&&p.current&&!p.current.contains(l)&&(f(!1),m(-1))};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[g]);const W=t=>{(t.key==="ArrowDown"||t.key==="Enter"||t.key===" ")&&(t.preventDefault(),f(!0),setTimeout(()=>{O.current?.focus(),m(0)},0))},K=t=>{if(x.length)if(t.key==="ArrowDown")t.preventDefault(),m(s=>(s+1)%x.length);else if(t.key==="ArrowUp")t.preventDefault(),m(s=>(s-1+x.length)%x.length);else if(t.key==="Enter"){t.preventDefault();const s=x[Math.max(0,b)];s&&(T(s),f(!1),m(-1),p.current?.focus())}else t.key==="Escape"&&(t.preventDefault(),f(!1),m(-1),p.current?.focus())},N=r.useCallback(async()=>{const t=localStorage.getItem("accessToken");try{A(!0);const l=await(await fetch(`${v}/refer/list_company_referral/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:localStorage.getItem("selectedReferralId")})})).json(),n=Array.isArray(l.referrals)?l.referrals[0]:null;y(n)}catch{u.error("⚠️ Failed to load referral detail")}finally{A(!1)}},[]);r.useEffect(()=>{N()},[N]),r.useEffect(()=>{(async()=>{try{const s=localStorage.getItem("accessToken"),l=localStorage.getItem("selectedId"),n=await fetch(`${v}/activity/?referral_id=${encodeURIComponent(l||"")}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:s?`Bearer ${s}`:""}}),h=await n.json();n.ok&&Array.isArray(h.results)&&U(h.results)}catch(s){console.error("Network error (activity):",s)}})()},[]);const J=async()=>{if(a){if(!c){u.error("⚠️ Please select a status.");return}_(!0);try{const t=localStorage.getItem("accessToken");if(o){const s=await fetch(`${v}/refer/complete1_referral/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:a.id,status:c})});if(!s.ok){const l=await s.text();u.error(`${l}`);return}await s.json(),u.success("✅ Status updated successfully!"),await N()}else{if(c!=="reject"&&!d){u.error("⚠️ Please select an employee before proceeding."),_(!1);return}const s=await fetch(`${v}/refer/assign_rep/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:a.id,status:c,employee_id:c==="reject"?null:d?.id,note:E||""})});if(!s.ok){const l=await s.text();u.error(`Failed: ${s.status} - ${l}`);return}await s.json(),u.success("✅ Status updated successfully!"),await N()}}catch{u.error("Network error, please try again")}finally{_(!1)}}};if(R||!a)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(te,{})});const C=(a.status||"").trim().toLowerCase(),q=C==="pending",i=C==="friend opted in",w=["completed","cancelled"].includes(C),Q=!o&&!a.assigned_to_id&&!w,V=o?!w:!w&&!a.assigned_to_id,X=o?S||!c||!i:S||!c||c!=="reject"&&!d||!i,Y=t=>{const s=(t||"").toLowerCase();return s==="completed"?"text-emerald-600 bg-emerald-50":s==="cancelled"?"text-rose-600 bg-rose-50":"text-amber-600 bg-amber-50"},z=()=>{if(o||!a.assigned_to_id&&!a.assigned_to_name)return null;const t=a.assigned_at||"",s=a.assigned_to_name||"",l=a.assigned_notes||"",n=h=>h&&h.trim().length?h:"—";return e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6 h-full",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Assignment Info"}),e.jsx("div",{className:"flex items-start justify-between gap-4 pt-2",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-9 w-9 rounded-full bg-black flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm font-semibold",children:D(s||"U")})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"inline-flex items-center w-fit px-3 py-1 rounded-lg text-xs sm:text-sm font-medium capitalize text-blue-700 bg-blue-50",children:n(s)}),e.jsxs("div",{className:"mt-2 space-y-1 text-xs text-gray-600 pt-2",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Assigned To:"})," ",n(s)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Assigned At:"})," ",n(t)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"Assigned Notes:"})," ",n(l)]})]})]})]})})]})};return e.jsxs("div",{className:"p-4 sm:p-6 flex flex-col min-h-screen space-y-6",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-semibold text-primary-blue text-center sm:text-left",children:"Referral Details"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsxs("div",{className:"flex flex-col items-start gap-1 sm:gap-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Reference ID"}),e.jsxs("p",{className:"font-semibold text-primary-blue text-sm sm:text-base",children:["#",a.reference_id]})]}),e.jsxs("div",{className:"text-left sm:text-right mt-3 sm:mt-0 flex flex-col items-start sm:items-end",children:[e.jsx("p",{className:"text-xs text-gray-500",children:a.date}),e.jsx("span",{className:`inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium mt-2 ${Y(a.status)}`,children:a.status})]})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Customer Info"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 sm:gap-4",children:[e.jsx("img",{src:`https://ui-avatars.com/api/?name=${encodeURIComponent(a.referred_to_name||"User")}&background=E5E7EB&color=374151`,alt:a.referred_to_name,className:"h-10 w-10 sm:h-12 sm:w-12 rounded-full object-cover"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"font-medium text-primary-blue text-sm sm:text-base",children:a.referred_to_name}),e.jsxs("p",{className:"text-xs text-gray-600 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 pb-2",children:[e.jsxs("span",{className:`flex items-center gap-1 ${a.privacy?"blur-sm select-none":""}`,children:[e.jsx(se,{className:"text-gray-500 text-sm"}),a.referred_to_email]}),e.jsxs("span",{className:`flex items-center gap-1 ${a.privacy?"blur-sm select-none":""}`,children:[e.jsx(ae,{className:"text-gray-500"}),a.referred_to_phone]})]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Reason:"})," ",a.reason]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Notes:"})," ",a.notes]})]})]}),e.jsx("div",{children:e.jsx("span",{className:`inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium capitalize
                ${(a.urgency||"").toLowerCase()==="urgent"?"text-rose-500 bg-rose-50":(a.urgency||"").toLowerCase()==="normal"?"text-blue-500 bg-blue-50":(a.urgency||"").toLowerCase()==="low"?"text-amber-500 bg-amber-50":"text-slate-500 bg-slate-50"}`,children:a.urgency})})]})]}),w?e.jsxs(e.Fragment,{children:[!o&&(a.assigned_to_id||a.assigned_to_name)&&e.jsx(z,{}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Activity Log"}),e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-[7px] top-0 bottom-0 w-px bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:j.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No activity yet."}):j.map(t=>{const s=new Date(t.created_at),l=s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),n=s.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-[22px] top-1 h-3 w-3 rounded-full bg-emerald-500"}),e.jsx("p",{className:"text-xs text-gray-500",children:l}),e.jsx("p",{className:"text-primary-blue font-medium text-sm",children:t.title}),e.jsx("p",{className:"text-xs text-gray-500",children:t.body}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:n})]},t.id)})})]})]})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6",children:[Q&&e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-2",children:"Assignment"}),q&&e.jsx("p",{className:"text-[11px] sm:text-xs text-amber-600 bg-amber-50 border border-amber-100 rounded-md px-2 py-1 mb-3",children:"Employee can be selected only after the friend opts in. While pending, it isn’t allowed"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>i&&$(t=>!t),disabled:!i,className:`w-full border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base text-left focus:outline-none
                    ${i?"focus:ring-2 focus:ring-primary-purple":"opacity-60 cursor-not-allowed"}
                    flex justify-between items-center`,children:[d?d.name:"Select Employee",e.jsx(re,{className:"text-gray-400"})]}),M&&i&&e.jsx("div",{className:"absolute z-20 mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto",children:P?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"Loading..."}):L.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No team members found"}):L.map(t=>e.jsxs("div",{onClick:()=>{F(t),$(!1)},className:"flex items-center gap-3 px-4 py-2 cursor-pointer hover:bg-gray-50",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-black flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm font-semibold",children:D(t.name)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:t.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.email})]})]},t.id))})]}),d&&e.jsxs("div",{className:"mt-5 flex items-center gap-3 p-3 border border-gray-100 rounded-xl bg-gray-50",children:[e.jsx("div",{className:"h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-black flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm sm:text-base font-semibold",children:D(d.name)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:d.name}),e.jsx("p",{className:"text-xs text-gray-500",children:d.email})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"⚠️ Only one employee can be assigned."})]}),!o&&a.assigned_to_id&&e.jsx("div",{className:"lg:col-span-1",children:e.jsx(z,{})}),V&&e.jsxs("div",{className:`bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6 ${o&&!a.assigned_to_id?"lg:col-span-2":""}`,children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-2",children:"Status Update"}),!i&&e.jsx("p",{className:"text-[11px] sm:text-xs text-amber-600 bg-amber-50 border border-amber-100 rounded-md px-2 py-1 mb-3",children:"Status can be selected only after the friend opts in. While pending, it isn’t allowed"}),e.jsxs("div",{className:"relative",ref:k,children:[e.jsxs("button",{ref:p,type:"button",onClick:()=>{i&&(f(t=>!t),setTimeout(()=>m(0),0))},onKeyDown:W,"aria-haspopup":"listbox","aria-expanded":g,disabled:!i,className:`group w-full px-4 pr-10 py-3 rounded-xl bg-white border border-gray-200 text-left
                             text-sm text-gray-800 outline-none ${i?"focus:ring-2 focus:ring-primary-purple":"opacity-60 cursor-not-allowed"} relative`,children:[c||"Select status",e.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 transition-transform",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-4 w-4 transition-transform ${g?"rotate-180":""}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M6 9l6 6 6-6",strokeLinecap:"round",strokeLinejoin:"round"})})})]}),g&&i&&e.jsx("div",{className:"absolute z-30 mt-2 w-full bg-white border border-gray-200 rounded-2xl shadow-xl overflow-hidden",children:e.jsx("ul",{ref:O,tabIndex:0,onKeyDown:K,role:"listbox","aria-activedescendant":b>=0&&x[b]?`status-${x[b]}`:void 0,className:"max-h-60 overflow-y-auto py-1 focus:outline-none",children:x.map((t,s)=>{const l=s===b,n=c===t;return e.jsx("li",{role:"option","aria-selected":n,children:e.jsxs("button",{id:`status-${t}`,type:"button",onMouseEnter:()=>m(s),onClick:()=>{T(t),f(!1),m(-1),p.current?.focus()},className:["w-full px-4 py-2.5 flex items-center gap-3 text-left transition",l?"bg-primary-purple/10":"hover:bg-primary-purple/10"].join(" "),children:[e.jsx("span",{className:"text-sm text-primary-blue capitalize",children:t}),n&&e.jsx("span",{className:"ml-auto text-primary-purple text-sm",children:"✓"})]})},t)})})})]}),!o&&e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"text-sm font-semibold text-primary-blue mt-5",children:"Note"}),e.jsx("textarea",{placeholder:"Write here...",value:E,onChange:t=>G(t.target.value),disabled:!i,className:`w-full mt-2 border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none ${i?"focus:ring-2 focus:ring-primary-purple":"opacity-60 cursor-not-allowed"}`,rows:4})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(le,{text:S?"Submitting...":"Done",onClick:J,disabled:X})})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Activity Log"}),e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-[7px] top-0 bottom-0 w-px bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:j.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No activity yet."}):j.map(t=>{const s=new Date(t.created_at),l=s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),n=s.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-[22px] top-1 h-3 w-3 rounded-full bg-emerald-500"}),e.jsx("p",{className:"text-xs text-gray-500",children:l}),e.jsx("p",{className:"text-primary-blue font-medium text-sm",children:t.title}),e.jsx("p",{className:"text-xs text-gray-500",children:t.body}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:n})]},t.id)})})]})]})]}),e.jsx(ne,{position:"top-right",autoClose:3e3,hideProgressBar:!0})]})};export{me as default};
