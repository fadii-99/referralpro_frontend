import{r,i as D,j as e,S as I,o as L,p as T,q as $}from"./index-Cw_ebVUy.js";import{B as R}from"./Button-D7uuoXZF.js";import{y as c,L as E}from"./ReactToastify-CdOU4tch.js";const x="/api",U=()=>{const[t,j]=r.useState(null),[N,p]=r.useState(!1),[u,v]=r.useState([]),{membersFromApi:g,loading:w}=D(),[l,S]=r.useState(null),[h,f]=r.useState(!1),[d,_]=r.useState("Accept"),[b,k]=r.useState(""),[A,y]=r.useState(!1),m=r.useCallback(async()=>{const s=localStorage.getItem("accessToken"),a=localStorage.getItem("selectedReferralId");try{p(!0);const n=await(await fetch(`${x}/refer/list_company_referral/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s?`Bearer ${s}`:""},body:JSON.stringify({referral_id:a})})).json(),o=Array.isArray(n.referrals)?n.referrals[0]:null;j(o)}catch{c.error("⚠️ Failed to load referral detail")}finally{p(!1)}},[]);r.useEffect(()=>{m()},[m]),r.useEffect(()=>{(async()=>{try{const a=localStorage.getItem("accessToken"),i=localStorage.getItem("selectedId"),n=await fetch(`${x}/activity/?referral_id=${encodeURIComponent(i||"")}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:a?`Bearer ${a}`:""}}),o=await n.json();console.log("[Activity API Response]:",o),n.ok&&Array.isArray(o.results)&&v(o.results)}catch(a){console.error("Network error (activity):",a)}})()},[]);const C=async()=>{if(t){if(!l&&d!=="Reject"){c.error("⚠️ Please select an employee before proceeding.");return}y(!0);try{const s=localStorage.getItem("accessToken"),a=await fetch(`${x}/refer/assign_rep/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s?`Bearer ${s}`:""},body:JSON.stringify({referral_id:t.id,status:d,employee_id:d==="Reject"?null:l?.id,note:b||""})});if(!a.ok){const n=await a.text();c.error(`Failed: ${a.status} - ${n}`);return}const i=await a.json();c.success("✅ Status updated successfully!"),console.log("Status update response:",i),await m()}catch{c.error("Network error, please try again")}finally{y(!1)}}};return N||!t?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(I,{})}):e.jsxs("div",{className:"p-4 sm:p-6 flex flex-col min-h-screen space-y-6",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-semibold text-primary-blue text-center sm:text-left",children:"Referral Details"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsxs("div",{className:"flex flex-col items-start gap-1 sm:gap-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Reference ID"}),e.jsxs("p",{className:"font-semibold text-primary-blue text-sm sm:text-base",children:["#",t.reference_id]})]}),e.jsxs("div",{className:"text-left sm:text-right mt-3 sm:mt-0 flex flex-col items-start sm:items-end",children:[e.jsx("p",{className:"text-xs text-gray-500",children:t.date}),e.jsx("span",{className:"inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium text-amber-500 bg-amber-50 mt-2",children:t.status})]})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Customer Info"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 sm:gap-4",children:[e.jsx("img",{src:`https://ui-avatars.com/api/?name=${encodeURIComponent(t.referred_to_name||"User")}&background=E5E7EB&color=374151`,alt:t.referred_to_name,className:"h-10 w-10 sm:h-12 sm:w-12 rounded-full object-cover"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"font-medium text-primary-blue text-sm sm:text-base",children:t.referred_to_name}),e.jsxs("p",{className:"text-xs text-gray-600 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 pb-2",children:[e.jsxs("span",{className:`flex items-center gap-1 ${t.privacy?"blur-sm select-none":""}`,children:[e.jsx(L,{className:"text-gray-500 text-sm"}),t.referred_to_email]}),e.jsxs("span",{className:`flex items-center gap-1 ${t.privacy?"blur-sm select-none":""}`,children:[e.jsx(T,{className:"text-gray-500"}),t.referred_to_phone]})]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Reason:"})," ",t.reason]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Notes:"})," ",t.notes]})]})]}),e.jsx("div",{children:e.jsx("span",{className:`inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium capitalize
                ${t.urgency?.toLowerCase()==="urgent"?"text-rose-500 bg-rose-50":t.urgency?.toLowerCase()==="normal"?"text-blue-500 bg-blue-50":"text-slate-500 bg-slate-50"}`,children:t.urgency})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6",children:[t.assigned_to_id?e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6 lg:col-span-2",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Assigned Info"}),e.jsxs("div",{className:"flex flex-col gap-4 mt-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Assigned To"}),e.jsx("p",{className:"text-sm sm:text-base font-semibold text-primary-blue",children:t.assigned_to_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Assigned Date"}),e.jsx("p",{className:"text-sm sm:text-base text-primary-blue font-semibold",children:t.assigned_at})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Notes"}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-700",children:t.assigned_notes||"—"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Assignment"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>f(!h),className:"w-full border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base text-left focus:outline-none focus:ring-2 focus:ring-primary-purple flex justify-between items-center",children:[l?l.name:"Select Employee",e.jsx($,{className:"text-gray-400"})]}),h&&e.jsx("div",{className:"absolute z-20 mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto",children:w?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"Loading..."}):g.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No team members found"}):g.map(s=>e.jsxs("div",{onClick:()=>{S(s),f(!1)},className:"flex items-center gap-3 px-4 py-2 cursor-pointer hover:bg-gray-50",children:[e.jsx("img",{src:s.avatar,alt:s.name,className:"h-8 w-8 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.email})]})]},s.id))})]}),l&&e.jsxs("div",{className:"mt-5 flex items-center gap-3 p-3 border border-gray-100 rounded-xl bg-gray-50",children:[e.jsx("img",{src:l.avatar,alt:l.name,className:"h-8 w-8 sm:h-10 sm:w-10 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:l.name}),e.jsx("p",{className:"text-xs text-gray-500",children:l.email})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"⚠️ Only one employee can be assigned."})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Status Update"}),e.jsxs("select",{value:d,onChange:s=>_(s.target.value),className:"w-full border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary-purple",children:[e.jsx("option",{children:"Accept"}),e.jsx("option",{children:"Reject"})]}),e.jsx("h4",{className:"text-sm font-semibold text-primary-blue mt-5",children:"Note"}),e.jsx("textarea",{placeholder:"Write here...",value:b,onChange:s=>k(s.target.value),className:"w-full mt-2 border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary-purple",rows:4}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(R,{text:A?"Submitting...":"Done",onClick:C,disabled:!l})})]})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Activity Log"}),e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-[7px] top-0 bottom-0 w-px bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:u.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No activity yet."}):u.map(s=>{const a=new Date(s.created_at),i=a.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),n=a.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-[22px] top-1 h-3 w-3 rounded-full bg-emerald-500"}),e.jsx("p",{className:"text-xs text-gray-500",children:i}),e.jsx("p",{className:"text-primary-blue font-medium text-sm",children:s.title}),e.jsx("p",{className:"text-xs text-gray-500",children:s.body}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:n})]},s.id)})})]})]})]}),e.jsx(E,{position:"top-right",autoClose:3e3,hideProgressBar:!0})]})};export{U as default};
