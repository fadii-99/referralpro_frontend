import{r,i as I,j as e,S as L,o as T,p as $,q as E}from"./index-B9bS0XpA.js";import{B as R}from"./Button-Ds5y04VV.js";import{y as o,L as B}from"./ReactToastify-CmpZpHZr.js";const p="/api",N=s=>{const c=(s||"").trim().charAt(0);return c?c.toUpperCase():"?"},P=()=>{const[s,c]=r.useState(null),[v,u]=r.useState(!1),[h,w]=r.useState([]),{membersFromApi:g,loading:S}=I(),[l,_]=r.useState(null),[f,b]=r.useState(!1),[d,k]=r.useState("Accept"),[y,A]=r.useState(""),[C,j]=r.useState(!1),x=r.useCallback(async()=>{const t=localStorage.getItem("accessToken"),a=localStorage.getItem("selectedReferralId");try{u(!0);const n=await(await fetch(`${p}/refer/list_company_referral/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:a})})).json(),m=Array.isArray(n.referrals)?n.referrals[0]:null;c(m)}catch{o.error("⚠️ Failed to load referral detail")}finally{u(!1)}},[]);r.useEffect(()=>{x()},[x]),r.useEffect(()=>{(async()=>{try{const a=localStorage.getItem("accessToken"),i=localStorage.getItem("selectedId"),n=await fetch(`${p}/activity/?referral_id=${encodeURIComponent(i||"")}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:a?`Bearer ${a}`:""}}),m=await n.json();n.ok&&Array.isArray(m.results)&&w(m.results)}catch(a){console.error("Network error (activity):",a)}})()},[]);const D=async()=>{if(s){if(!l&&d!=="Reject"){o.error("⚠️ Please select an employee before proceeding.");return}j(!0);try{const t=localStorage.getItem("accessToken"),a=await fetch(`${p}/refer/assign_rep/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify({referral_id:s.id,status:d,employee_id:d==="Reject"?null:l?.id,note:y||""})});if(!a.ok){const n=await a.text();o.error(`Failed: ${a.status} - ${n}`);return}const i=await a.json();o.success("✅ Status updated successfully!"),console.log("Status update response:",i),await x()}catch{o.error("Network error, please try again")}finally{j(!1)}}};return v||!s?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(L,{})}):e.jsxs("div",{className:"p-4 sm:p-6 flex flex-col min-h-screen space-y-6",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-semibold text-primary-blue text-center sm:text-left",children:"Referral Details"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsxs("div",{className:"flex flex-col items-start gap-1 sm:gap-2",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Reference ID"}),e.jsxs("p",{className:"font-semibold text-primary-blue text-sm sm:text-base",children:["#",s.reference_id]})]}),e.jsxs("div",{className:"text-left sm:text-right mt-3 sm:mt-0 flex flex-col items-start sm:items-end",children:[e.jsx("p",{className:"text-xs text-gray-500",children:s.date}),e.jsx("span",{className:"inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium text-amber-500 bg-amber-50 mt-2",children:s.status})]})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Customer Info"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 sm:gap-4",children:[e.jsx("img",{src:`https://ui-avatars.com/api/?name=${encodeURIComponent(s.referred_to_name||"User")}&background=E5E7EB&color=374151`,alt:s.referred_to_name,className:"h-10 w-10 sm:h-12 sm:w-12 rounded-full object-cover"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"font-medium text-primary-blue text-sm sm:text-base",children:s.referred_to_name}),e.jsxs("p",{className:"text-xs text-gray-600 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 pb-2",children:[e.jsxs("span",{className:`flex items-center gap-1 ${s.privacy?"blur-sm select-none":""}`,children:[e.jsx(T,{className:"text-gray-500 text-sm"}),s.referred_to_email]}),e.jsxs("span",{className:`flex items-center gap-1 ${s.privacy?"blur-sm select-none":""}`,children:[e.jsx($,{className:"text-gray-500"}),s.referred_to_phone]})]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Reason:"})," ",s.reason]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Notes:"})," ",s.notes]})]})]}),e.jsx("div",{children:e.jsx("span",{className:`inline-flex items-center px-2 sm:px-3 py-1 rounded-lg text-xs font-medium capitalize
                ${s.urgency?.toLowerCase()==="urgent"?"text-rose-500 bg-rose-50":s.urgency?.toLowerCase()==="normal"?"text-blue-500 bg-blue-50":"text-slate-500 bg-slate-50"}`,children:s.urgency})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6",children:[s.assigned_to_id?e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6 lg:col-span-2",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Assigned Info"}),e.jsxs("div",{className:"flex flex-col gap-4 mt-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Assigned To"}),e.jsx("p",{className:"text-sm sm:text-base font-semibold text-primary-blue",children:s.assigned_to_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Assigned Date"}),e.jsx("p",{className:"text-sm sm:text-base text-primary-blue font-semibold",children:s.assigned_at})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Notes"}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-700",children:s.assigned_notes||"—"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Assignment"}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>b(!f),className:"w-full border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base text-left focus:outline-none focus:ring-2 focus:ring-primary-purple flex justify-between items-center",children:[l?l.name:"Select Employee",e.jsx(E,{className:"text-gray-400"})]}),f&&e.jsx("div",{className:"absolute z-20 mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto",children:S?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"Loading..."}):g.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No team members found"}):g.map(t=>e.jsxs("div",{onClick:()=>{_(t),b(!1)},className:"flex items-center gap-3 px-4 py-2 cursor-pointer hover:bg-gray-50",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-black flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm font-semibold",children:N(t.name)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:t.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.email})]})]},t.id))})]}),l&&e.jsxs("div",{className:"mt-5 flex items-center gap-3 p-3 border border-gray-100 rounded-xl bg-gray-50",children:[e.jsx("div",{className:"h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-black flex items-center justify-center",children:e.jsx("span",{className:"text-white text-sm sm:text-base font-semibold",children:N(l.name)})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-primary-blue",children:l.name}),e.jsx("p",{className:"text-xs text-gray-500",children:l.email})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"⚠️ Only one employee can be assigned."})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Status Update"}),e.jsxs("select",{value:d,onChange:t=>k(t.target.value),className:"w-full border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary-purple",children:[e.jsx("option",{children:"Accept"}),e.jsx("option",{children:"Reject"})]}),e.jsx("h4",{className:"text-sm font-semibold text-primary-blue mt-5",children:"Note"}),e.jsx("textarea",{placeholder:"Write here...",value:y,onChange:t=>A(t.target.value),className:"w-full mt-2 border border-gray-200 rounded-xl px-3 py-2 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-primary-purple",rows:4}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(R,{text:C?"Submitting...":"Done",onClick:D,disabled:!l})})]})]}),e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-sm border border-black/5 p-4 sm:p-6",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold text-primary-blue mb-4",children:"Activity Log"}),e.jsxs("div",{className:"relative pl-6",children:[e.jsx("div",{className:"absolute left-[7px] top-0 bottom-0 w-px bg-gray-200"}),e.jsx("div",{className:"space-y-6",children:h.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No activity yet."}):h.map(t=>{const a=new Date(t.created_at),i=a.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}),n=a.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute -left-[22px] top-1 h-3 w-3 rounded-full bg-emerald-500"}),e.jsx("p",{className:"text-xs text-gray-500",children:i}),e.jsx("p",{className:"text-primary-blue font-medium text-sm",children:t.title}),e.jsx("p",{className:"text-xs text-gray-500",children:t.body}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:n})]},t.id)})})]})]})]}),e.jsx(B,{position:"top-right",autoClose:3e3,hideProgressBar:!0})]})};export{P as default};
